import paramiko
import os
import logging
import sys
import pandas as pd
from datetime import datetime

# ==== CONFIGURATION ====
USERNAME = "posuser"
PASSWORD = "till@123"
LOCAL_FOLDER = r"C:\Source\ETPStoreFrontV5.5"
REMOTE_TEMP_FOLDER = "/home/posuser/ETPStoreFrontV5.5"
REMOTE_DEST_FOLDER = "/home/posuser/ETPSuite"
LOG_FILE = "master_deployment_log.log"
STORES_FILE = "stores.txt"

# Setup logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] - %(message)s",
    handlers=[logging.FileHandler(LOG_FILE, encoding='utf-8'), logging.StreamHandler(sys.stdout)]
)

def ssh_connect(ip):
    client = paramiko.SSHClient()
    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    try:
        client.connect(ip, username=USERNAME, password=PASSWORD, timeout=10)
        return client
    except Exception as e:
        logging.error(f"Failed to connect to {ip}: {e}")
        return None

def run_command(client, command):
    stdin, stdout, stderr = client.exec_command(command)
    exit_status = stdout.channel.recv_exit_status()
    error_message = stderr.read().decode().strip()
    return exit_status, error_message

def upload_directory(sftp, local_dir, remote_dir):
    try: sftp.stat(remote_dir)
    except FileNotFoundError: sftp.mkdir(remote_dir)
    for item in os.listdir(local_dir):
        local_path = os.path.join(local_dir, item).replace("\\", "/")
        remote_path = f"{remote_dir}/{item}"
        if os.path.isdir(local_path):
            upload_directory(sftp, local_path, remote_path)
        else:
            sftp.put(local_path, remote_path)

def setup_keys_for_store(store_tills):
    source_till_ip = store_tills[0]
    logging.info(f"Performing one-time key setup for store {source_till_ip}...")
    source_client = ssh_connect(source_till_ip)
    if not source_client: return False
    
    # --- THIS IS THE FIX ---
    # Forcefully remove old keys before creating new ones to prevent interactive prompts.
    # The -f flag means "force" and won't show an error if the files don't exist.
    logging.info("  -> Removing any old SSH keys to ensure a clean setup...")
    run_command(source_client, "rm -f ~/.ssh/id_rsa ~/.ssh/id_rsa.pub")
    # --- END OF FIX ---
    
    run_command(source_client, "mkdir -p ~/.ssh")
    run_command(source_client, 'ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""')
    exit_status, public_key = run_command(source_client, "cat ~/.ssh/id_rsa.pub")
    source_client.close()
    
    if not public_key:
        logging.error("Could not generate or read public key. Setup failed.")
        return False
    
    for till_ip in store_tills:
        target_client = ssh_connect(till_ip)
        if target_client:
            auth_command = (f"mkdir -p ~/.ssh && echo '{public_key}' >> ~/.ssh/authorized_keys && "
                            f"chmod 700 ~/.ssh && chmod 600 ~/.ssh/authorized_keys")
            run_command(target_client, auth_command)
            target_client.close()
            
    logging.info("Key setup complete for this store.")
    return True

def deploy_to_store(store_tills):
    source_till_ip = store_tills[0]
    store_results = []
    is_store_successful = True

    logging.info(f"Starting deployment for store {source_till_ip}...")
    source_client_check = ssh_connect(source_till_ip)
    if not source_client_check:
        for till_ip in store_tills:
            store_results.append({'Store_Hub': source_till_ip, 'Till_IP': till_ip, 'Status': 'Failed', 'Reason': 'Could not connect to the store hub (Till 1).'})
        return False, store_results

    exit_status, result = run_command(source_client_check, f"ssh -o PasswordAuthentication=no -o BatchMode=yes {USERNAME}@{source_till_ip} 'echo success'")
    source_client_check.close()
    if "success" not in result:
        logging.warning("Passwordless SSH not configured. Running setup...")
        if not setup_keys_for_store(store_tills):
            for till_ip in store_tills:
                store_results.append({'Store_Hub': source_till_ip, 'Till_IP': till_ip, 'Status': 'Failed', 'Reason': 'One-time key setup failed.'})
            return False, store_results
    else:
        logging.info("Passwordless SSH is already configured.")

    source_client = ssh_connect(source_till_ip)
    if not source_client:
        for till_ip in store_tills:
            store_results.append({'Store_Hub': source_till_ip, 'Till_IP': till_ip, 'Status': 'Failed', 'Reason': 'Could not connect to the store hub (Till 1).'})
        return False, store_results
    
    try:
        logging.info("  Uploading files from PC to Till 1...")
        source_client.exec_command(f"rm -rf {REMOTE_TEMP_FOLDER}")
        sftp = source_client.open_sftp()
        upload_directory(sftp, LOCAL_FOLDER, REMOTE_TEMP_FOLDER)
        sftp.close()
    except Exception as e:
        logging.error(f"  Upload to Till 1 failed: {e}")
        source_client.close()
        for till_ip in store_tills:
            store_results.append({'Store_Hub': source_till_ip, 'Till_IP': till_ip, 'Status': 'Failed', 'Reason': f'Upload from PC to Till 1 failed: {e}'})
        return False, store_results

    logging.info("  Distributing files from Till 1 to other tills in the store...")
    for till_ip in store_tills:
        logging.info(f"    -> Deploying to {till_ip}...")
        cmd = (
            f"ssh -o StrictHostKeyChecking=no {USERNAME}@{till_ip} 'rm -rf {REMOTE_DEST_FOLDER}' && "
            f"scp -o StrictHostKeyChecking=no -r {REMOTE_TEMP_FOLDER} {USERNAME}@{till_ip}:{REMOTE_DEST_FOLDER}"
        )
        exit_status, error_msg = run_command(source_client, cmd)
        
        if exit_status == 0:
            store_results.append({'Store_Hub': source_till_ip, 'Till_IP': till_ip, 'Status': 'Success', 'Reason': ''})
            logging.info(f"    -> SUCCESS for {till_ip}")
        else:
            store_results.append({'Store_Hub': source_till_ip, 'Till_IP': till_ip, 'Status': 'Failed', 'Reason': error_msg})
            logging.error(f"   -> FAILED for {till_ip}: {error_msg}")
            is_store_successful = False

    source_client.exec_command(f"rm -rf {REMOTE_TEMP_FOLDER}")
    source_client.close()
    logging.info(f"Deployment processing complete for store {source_till_ip}.")
    return is_store_successful, store_results

# --- Main Execution ---
if __name__ == "__main__":
    if not os.path.exists(STORES_FILE):
        logging.critical(f"Stores list file not found: '{STORES_FILE}'")
        sys.exit(1)

    stores_to_process = []
    with open(STORES_FILE, 'r') as f:
        for line in f:
            if line.strip() and not line.startswith('#'):
                parts = line.strip().split()
                stores_to_process.append((parts[0], int(parts[1])))

    failed_stores_hubs = []
    all_results = []

    for start_ip, num_tills in stores_to_process:
        ip_parts = start_ip.split('.')
        base_ip = ".".join(ip_parts[:3])
        start_octet = int(ip_parts[3])
        current_store_tills = [f"{base_ip}.{start_octet + i}" for i in range(num_tills)]
        
        logging.info(f"\n{'='*20} PROCESSING STORE: {start_ip} {'='*20}")
        success, results = deploy_to_store(current_store_tills)
        all_results.extend(results)
        if not success:
            failed_stores_hubs.append(start_ip)

    logging.info(f"\n{'='*25} CREATING REPORT {'='*25}")
    try:
        report_df = pd.DataFrame(all_results)
        timestamp = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
        report_filename = f"deployment_report_{timestamp}.xlsx"
        report_df.to_excel(report_filename, index=False)
        logging.info(f"Successfully created report: {report_filename}")
    except Exception as e:
        logging.error(f"Could not create Excel report: {e}")

    logging.info(f"\n{'='*25} FINAL SUMMARY {'='*25}")
    if not failed_stores_hubs:
        logging.info("All stores were processed successfully!")
    else:
        logging.warning(f"Deployment had failures in the following stores: {', '.join(failed_stores_hubs)}")

