import os
import logging
import shutil
import paramiko
import socket
import pandas as pd
from stat import S_ISDIR
from datetime import datetime
import tkinter as tk
from tkinter import filedialog, messagebox, scrolledtext, ttk
from threading import Thread, Event
from concurrent.futures import ThreadPoolExecutor, as_completed
import atexit

# Configuration - Adjust as needed
DEFAULT_SOURCE_FOLDER = r'C:\Source\ETPStoreFrontV5.5'
HOST_USER = 'linuxadmin'
HOST_PASS = 'St0re@dm1n'  # Confirmed as per your message
TILL_USER = 'posuser'
TILL_PASS = 'till@123'
TILL_START_OCTET = 111  # Till1 -> .112, Till2 -> .113, etc. (111 + till_num)
TILL_DEST_BASE = '/home/posuser/ETPSuite/ETPStoreFrontV5.5'  # As per requirement
HOST_DEST = '/home/linuxadmin/ETPStoreFrontV5.5'  # Fixed for hosts
HOST_OPERATIONS_DEST = '/home/linuxadmin/ETPSuite'  # Destination for ETP Store Operations
TIMEOUT_CONNECT = 3  # Seconds for connection attempts
TIMEOUT_TRANSFER = 6  # Approximate for transfer operations (paramiko timeouts)
MAX_WORKERS = 5  # Number of concurrent hosts to process (adjust based on network capacity)

SOURCE_FOLDER = DEFAULT_SOURCE_FOLDER  # Global, set dynamically

class DeploymentGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("ETP Deployment Tool")
        self.root.geometry("800x700")

        # Variables
        self.source_folder = tk.StringVar(value=DEFAULT_SOURCE_FOLDER)
        self.config_file = tk.StringVar(value='deployment_config.xlsx')
        self.manual_host_ip = tk.StringVar()
        self.manual_till_nums = tk.StringVar()
        self.stop_event = Event()
        self.is_deploying = False
        self.is_reattempting = False
        self.is_manual = False
        self.logger = None
        self.deployment_thread = None
        self.reattempt_thread = None
        self.manual_thread = None
        self.excel_log = None
        self.last_results_file = None
        self.total_hosts = 0
        self.completed_hosts = 0
        self.results = []  # Track results for periodic saving

        self.setup_ui()
        self.setup_logging()
        atexit.register(self.save_on_exit)  # Save on app crash/exit

    def save_on_exit(self):
        if self.results and self.excel_log:
            try:
                pd.DataFrame(self.results).to_excel(self.excel_log, index=False)
                self.logger.info("Emergency save completed on exit.")
            except Exception as e:
                self.logger.error(f"Emergency save failed: {str(e)}")

    def setup_ui(self):
        # Source Folder Selection
        tk.Label(self.root, text="Source Folder:").pack(pady=5)
        source_frame = tk.Frame(self.root)
        source_frame.pack(pady=5, fill=tk.X, padx=10)
        tk.Entry(source_frame, textvariable=self.source_folder, width=60).pack(side=tk.LEFT, fill=tk.X, expand=True)
        tk.Button(source_frame, text="Browse", command=self.browse_source).pack(side=tk.RIGHT, padx=5)

        # Config File Selection
        tk.Label(self.root, text="Config Excel File:").pack(pady=5)
        config_frame = tk.Frame(self.root)
        config_frame.pack(pady=5, fill=tk.X, padx=10)
        tk.Entry(config_frame, textvariable=self.config_file, width=60).pack(side=tk.LEFT, fill=tk.X, expand=True)
        tk.Button(config_frame, text="Browse", command=self.browse_config).pack(side=tk.RIGHT, padx=5)

        # Manual Mode Section
        manual_frame = tk.LabelFrame(self.root, text="Manual Deployment", padx=10, pady=10)
        manual_frame.pack(pady=10, fill=tk.X, padx=10)

        # Host IP
        tk.Label(manual_frame, text="Host IP (e.g., 10.0.70.12):").grid(row=0, column=0, sticky=tk.W, pady=2)
        tk.Entry(manual_frame, textvariable=self.manual_host_ip, width=30).grid(row=0, column=1, padx=5, pady=2)

        # Till Numbers
        tk.Label(manual_frame, text="Till Numbers (comma-separated, e.g., 1,3,4):").grid(row=1, column=0, sticky=tk.W, pady=2)
        tk.Entry(manual_frame, textvariable=self.manual_till_nums, width=30).grid(row=1, column=1, padx=5, pady=2)

        self.manual_btn = tk.Button(manual_frame, text="Manual Deploy", command=self.start_manual, bg='purple', fg='white', width=15)
        self.manual_btn.grid(row=2, column=0, columnspan=2, pady=10)

        # Buttons Frame
        button_frame = tk.Frame(self.root)
        button_frame.pack(pady=10)

        self.start_btn = tk.Button(button_frame, text="Start Deployment", command=self.start_deployment, bg='green', fg='white', width=15)
        self.start_btn.pack(side=tk.LEFT, padx=5)

        self.stop_btn = tk.Button(button_frame, text="Stop Deployment", command=self.stop_deployment, bg='red', fg='white', width=15, state=tk.DISABLED)
        self.stop_btn.pack(side=tk.LEFT, padx=5)

        self.reattempt_btn = tk.Button(button_frame, text="Reattempt Failed Tills", command=self.start_reattempt, bg='blue', fg='white', width=20)
        self.reattempt_btn.pack(side=tk.LEFT, padx=5)

        # Progress Bar
        self.progress = ttk.Progressbar(self.root, mode='determinate', length=400, maximum=100)
        self.progress.pack(pady=10, fill=tk.X, padx=10)

        # Progress Label
        self.progress_label = tk.Label(self.root, text="0% Complete")
        self.progress_label.pack(pady=5)

        # Status Label
        self.status_label = tk.Label(self.root, text="Ready", relief=tk.SUNKEN, anchor=tk.W)
        self.status_label.pack(side=tk.BOTTOM, fill=tk.X, pady=5)

        # Log Text Area
        tk.Label(self.root, text="Log:").pack(pady=5)
        self.log_text = scrolledtext.ScrolledText(self.root, height=18, width=80)
        self.log_text.pack(pady=5, fill=tk.BOTH, expand=True, padx=10)

        # Results Button
        self.results_btn = tk.Button(self.root, text="Open Results Excel", command=self.open_results, state=tk.DISABLED)
        self.results_btn.pack(pady=5)

    def setup_logging(self):
        self.log_filename = f'deployment_{datetime.now().strftime("%Y%m%d_%H%M%S")}.log'
        file_handler = logging.FileHandler(self.log_filename)
        formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s')
        file_handler.setFormatter(formatter)

        self.logger = logging.getLogger(__name__)
        self.logger.setLevel(logging.INFO)
        self.logger.addHandler(file_handler)

        # Redirect to GUI
        class TextHandler(logging.Handler):
            def __init__(self, text_widget):
                logging.Handler.__init__(self)
                self.text_widget = text_widget

            def emit(self, record):
                msg = self.format(record)
                self.text_widget.insert(tk.END, msg + '\n')
                self.text_widget.see(tk.END)

        gui_handler = TextHandler(self.log_text)
        gui_handler.setFormatter(formatter)
        self.logger.addHandler(gui_handler)

    def browse_source(self):
        folder = filedialog.askdirectory(initialdir=self.source_folder.get())
        if folder:
            self.source_folder.set(folder)

    def browse_config(self):
        file = filedialog.askopenfilename(initialdir='.',